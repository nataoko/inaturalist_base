\documentclass{article}
\usepackage{graphicx}
\usepackage[T1]{fontenc}
\usepackage{polski}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}

\usepackage{geometry}
\newgeometry{tmargin=2.5cm,bmargin=2.5cm,lmargin=3cm,rmargin=3cm}

\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\title{Baza iNaturalist --- wystêpowanie gatunków zagro¿onych na~danym obszarze\\ \large{projekt z Pracowni informatycznej}}
\author{Natalia Okopna \\nr albumu: 123454\\\\\\\\ prowadz¹cy: dr hab. Wojciech Jakubowski}
\date{Grudzieñ 2021}

\begin{document}
\maketitle
\newpage
\tableofcontents
\newpage
 \section*{Projekt interface'u}

 \section{Menu g³ówne}
 Po otwarciu aplikacji u¿ytkownik dostaje kilka mo¿liwoœci do wyboru. Zapis nowego obszaru, wczytanie informacji oraz wyœwietlenie informacjo o aplikacji.
  \begin{figure}[h] 
\begin{center}
\includegraphics[scale =1]{"menu.png"}
\end{center}
\caption{Menu}
\label{}
\end{figure}
 \newpage
 \section{Wprowadzanie nowego obszaru}
 Aby wygenerowaæ opcje na danym obszarze, musi byæ on wprowadzony do bazy. \subsection{Okno wprowadzania obszaru}
 Po klikniêciu w menu g³ównym opcji \textit{Nowy obszar} otwiera nam siê nastêpuj¹ce okno.
 
 \begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.5]{"NowyObszar.png"}
\end{center}
\caption{Okno 'Nowy obszar'}
\label{}
\end{figure}

 Docelowo po wprowadzeniu ka¿dego punktu, generowany bêdzie interaktywnie obszar. Po zatwierdzeniu obszaru rozpoczyna siê proces walidacji oraz sprawdzenie, czy obszar jest spójny, omówione w kolejnych podrozdzia³ach. W razie b³êdu wyœwietli siê nastêpuj¹ce okno.
 
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"error5.png"}
\end{center}
\caption{Okno 'Error'}
\label{}
\end{figure}

W przeciwnym razie obszar zostaje zapisany do bazy. Pojawia siê okno z informacj¹.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"Zapisano.png"}
\end{center}
\caption{Okno informuj¹ce o zapisaniu obrazu}
\label{}
\end{figure}

\subsection{Walidacja danych}
Aby korzystaæ z funkcji \textit{shapely.Polygon} trzeba sprawdziæ poprawnoœæ danych wprowadzonych przez u¿ytkownika.
\begin{itemize}
\item Linia i punkt \\ 
W naszym programie obszar powinien zawieraæ minimum 3 punkty. Tworzymy funkcjê \textit{geo\_less\_than\_3}.
\begin{lstlisting}[language=Python, caption=geo\_less\_than\_3]
def geo_less_than_3(lista):
    if len(lista) < 3:
        return 1
return 0
\end{lstlisting}
Przyk³adowe wyjœcia funkcji:
\begin{lstlisting}[language=Python, caption=Za ma³o danych]
geo_less_than_3([('0','0')])
#1
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Za ma³o danych]
geo_less_than_3([('0','0'), ('0','1')])
#1
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Minimalna liczba danych]
geo_less_than_3([('0','0'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\item Inne znaki i zakres liczbowy.
Sprawdzamy, czy dane wejœciowe u¿ytkownika to liczby i to liczby z zakresu szerokoœci i d³ugoœci geograficznych œwiata. Tworzymy funkcjê \textit{geo\_float}, która zwraca numer b³êdu lub przekonwertowan¹ listê danych geograficznych.
\begin{lstlisting}[language=Python, caption=geo\_float]
def geo_float(lista):
  lista_float = []
  try:
    for long, lati in lista:
      try:
        long = round(float(long), 5)
        if long < -180 or long > 180:
          return 3
      except:
        return 2
      try:
        lati = round(float(lati), 5)
        if lati < -90 or lati > 90:
          return 5
      except:
        return 4
      lista_float.append((long, lati))
  except:
    return 0
  return lista_float
\end{lstlisting}
Przyk³ady: \\
wpisujemy b³êdne dane: 
\begin{lstlisting}[language=Python, caption=za krótka krotka]
geo_float([('0'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=za d³uga krotka]
geo_float([('1', '0','4'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=inne znaki]
geo_float([('0','a'), ('0','1'), ('0','2')])
#4
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=inne znaki]
geo_float([('a', '0'), ('0','1'), ('0','2')])
#2
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=liczby poza skal¹]
geo_float([('200', '0'), ('0','1'), ('0','2')])
#3
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=liczby poza skal¹]
geo_float([('2', '100'), ('0','1'), ('0','2')])
#5
\end{lstlisting}
oraz poprawne dane.
\begin{lstlisting}[language=Python, caption=poprawne dane]
geo_float([('1', '0'), ('0','1'), ('0','2')])
# [(1.0, 0.0), (0.0, 1.0), (0.0, 2.0)]
\end{lstlisting}
\subsection{Tworzenie obszarów}
Do tworzenia obszarów bêdziemy korzystaæ z biblioteki \textit{shapely.geometry}.
Tworzymy przyk³adowy obszar u¿ywaj¹c funkcji \textit{shapely.geometry.Polygon}. Jako argument dajemy listê punktów danych geograficznych.

\begin{lstlisting}[language=Python, caption=Przyk³adowy obszar]
from shapely.geometry import Polygon

test = [(10,0), (10,1), (10.5,0.5), (11,1), (11,0)]
test = Polygon(test)
test
\end{lstlisting}
Otrzymujemy obszar:

\begin{figure}[h] 
\begin{center}
\includegraphics[scale =1]{"polygon.PNG"}
\end{center}
\caption{Przyk³adowy obszar `test`}
\label{test}
\end{figure}

\subsection{Obszar spójny}
Sprawdzamy, czy wprowadzony przez u¿ytkownika obszarjest poprawny za pomoc¹ funkcji \textit{shapely.geometry.Polygon.is\_valid}. Funkcja zwraca
wartoœæ logiczn¹ \textit{True}, gdy obszar jest spójny. Mo¿e wiêc byæ to obszar wklês³y. Wiêcej mo¿na poczytaæ o tej funkcji w dokumentacji:  \url{https://shapely.readthedocs.io/en/stable/manual.html#polygons}.
Sprawdzamy poprawnoœæ stworzonego wczeœniej obszaru Rysunek \ref{test}.
\begin{lstlisting}[language=Python, caption=Obszar spójny]
test.is_valid
#True
\end{lstlisting}
Tworzymy obszar, w którym linie miêdzy punktami nachodz¹ na siebie (obszar nie jest spójny).
\begin{lstlisting}[language=Python, caption=Obszar spójny]
test1 = [(0,0), (0,1), (0.5,-1), (1,1), (1,0)]
test1 = Polygon(test1)
test1
\end{lstlisting}
Otrzymujemy figurê:
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 2]{"niespojny.PNG"}
\end{center}
\caption{Obszar niespójny `test1`}
\label{}
\end{figure}
Sprawdzamy jego poprawnoœæ:
\begin{lstlisting}[language=Python, caption=Obszar niespójny]
test1.is_valid
#False
\end{lstlisting}
Funkcja \textit{shapely.geometry.Polygon.is\_valid} zwraca wartoœæ \textit{False}. Czyli obszar nie jest poprawny.
\end{itemize}

\newpage
\section{Wczytywanie obserwacji}
Po klikniêciu w menu g³ównym opcji \textit{Obserwacje} wyœwietla nam siê nastêpuj¹ce okno.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"wczytajobs.png"}
\end{center}
\caption{Wczytywanie obserwacji}
\label{}
\end{figure}

\subsection{Wczytywanie obserwacji z dysku} Po klikniêciu \textit{Wczytaj z dysku} otwiera nam siê okno \textit{Wczytaj obserwacje z dysku}. 

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"wczytajobszdysku.png"}
\end{center}
\caption{Wczytywanie obserwacji z dysku}
\label{}
\end{figure}

Po klikniêciu \textit{Ok} wyœwietli siê okno \textit{Obserwacje} z wizualizacj¹ danych omówion¹ w kolejnych punktach.

\newpage
\subsection{Generowanie obserwacji z bazy}
Po klikniêciu \textit{Wczytaj z dysku} otwiera nam siê okno. 

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"generujzbazy.png"}
\end{center}
\caption{Generowanie z bazy}
\label{}
\end{figure}

Mo¿liwe b³êdy to: data spoza zakresu, z³y takson, brak internetu. W razie b³êdów bêd¹ pojawia³y siê odpowiednie okna b³êdu. Po zatwierdzeniu danych i wciœniêciu przycisku \textit{Generuj} zostaje wysy³ane zapytanie do bazy i wygenerowanie obserwacji. Zostaje wyœwietlone okno \textit{Obserwacje} omówione w dalszej czêœci.

\subsubsection{Zapytanie do bazy}
Zapytanie do bazy bêdzie kierowane poprzez funkcjê \textit{pyinaturalist.get\_observation\_species\_counts}, która bierze jako argumenty takson, datê startow¹ i koñcow¹ obserwacji oraz wartoœæ 0-1 czy gatunek danej obserwacji ma byæ zagro¿ony w lokalizacji obserwacji oraz czy obserwacja jest zweryfikowana. Mo¿na te¿ ustaliæ inne dodatkowe parametry o których wiêcej mo¿na poczytaæ w dokumentacji: \url{https://pyinaturalist.readthedocs.io/en/stable/modules/pyinaturalist.v1.observations.html#pyinaturalist.v1.observations.get_observation_species_counts}. Otrzymujemy zestaw obserwacji w postaci s³ownika JSON.
 \subsubsection{Obserwacja w obszarze}
Nastêpnie nale¿y sprawdziæ, które obserwacje nalez¹ do danego. Tworzymy punkt przy u¿yciu funkcji
\textit{shapely.geometry.Point}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
from shapely.geometry import Point
p1 = Point(10.5, 0.2)
\end{lstlisting}
Nastêpnie korzystamy z funkcji \textit{shapely.geometry.Polygon.contains()}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
test.contains(p1)
#True
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
p2 = Point(10.5, 1.2)
test.contains(p2)
#False
\end{lstlisting}
Punkt \textit{p1} nale¿y do obszaru \textit{test}, punkt \textit{p2} nie nale¿y.
\\\\Gdy mamy przefiltrowane obserwacje, zostaje wyœwietliæ je na mapie oraz w odpowiedni wizualnie sposób.

\newpage
\section{Wizualizacja danych}
Po wprowadzeniu obserwacji nastêpuje wyœwietlenie obserwacji. Poszczególne elementy okna s¹ opisane w nastêpnych podrozdzia³ach.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"obserwacje.png"}
\end{center}
\caption{Obserwacje}
\label{}
\end{figure}

\subsection{Tworzenie mapy}
Aby umieœciæ obszary na mapie, skorzystamy z biblioteki \textit{folium}: \url{https://python-visualization.github.io/folium/quickstart.html}.

Tworzymy obiekt \textit{mapa} okreœlaj¹c wymiary okna oraz widok. Domyœlny tryb mapy to: \textit{tiles = 'OpenStreetMap'}. W aplikacji bêdzie mo¿na zmieniæ tryb na \textit{'cartodbpositron'} oraz \textit{'Stamen Terrain'}.
\begin{lstlisting}[language=Python, caption=Mapa]
import folium
mapa = folium.Map(width=500, height=400, location=[0,10], zoom_start=5)
folium.TileLayer('cartodbpositron').add_to(mapa)
folium.TileLayer('Stamen Terrain').add_to(mapa)
folium.LayerControl().add_to(mapa)
mapa
\end{lstlisting}
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale =.75]{"mapaopcje.PNG"}
%\end{center}
\\
Rysunek: Domyœlny tryb
%\label{}
%\end{figure}
\\\\\\\\
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale = .75]{"mapa3.PNG"}
%\end{center}
\\Rysunek: Tryb 'cartodbpositron'
%\label{}
%\end{figure}
\end{tabular}
\end{center}
\newpage

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.75]{"mapaST.PNG"}
\end{center}
\caption{Tryb 'Stamen Terrain'}
\label{}
\end{figure}

\subsection{Umieszczanie obszaru na mapie}
Do mapy \textit{mapa} dodajemy nasz obszar \textit{test}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
import folium
mapa = folium.Map(width=500, height=400, location=[0,10], zoom_start=8)
folium.GeoJson(test).add_to(mapa) # dodanie obszaru
folium.TileLayer('cartodbpositron').add_to(mapa)
folium.TileLayer('Stamen Terrain').add_to(mapa)
folium.LayerControl().add_to(mapa)
mapa
\end{lstlisting}
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.5]{"mapaobszar.PNG"}
\end{center}
\caption{Mapa z obszarem}
\label{}
\end{figure}
\subsection{Umieszczanie obserwacji na mapie}

Tworzymy obiekt punktu korzystaj¹c z funkcji \textit{folium.Marker}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
folium.Marker([0, 10], popup="Znacznik").add_to(mapa)
mapa
\end{lstlisting}

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.55]{"znacznik.PNG"}
\end{center}
\caption{Mapa ze znacznikiem}
\label{}
\end{figure}

\subsection{Znacznik}
Docelowo po klikniêciu na znacznik bêdziemy widzieli okno. Skorzystamy z biblioteki \url{https://github.com/karolzak/ipyplot} w zmienionej na nasze potrzeby formie. Ta czêœæ bêdzie uwzglêdniona dopiero w procesie tworzenia aplikacji w przysz³oœci.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.65]{"znacznikfoto.PNG"}
\end{center}
\caption{Znacznik z informacjami}
\label{}
\end{figure}

\subsection{Wyœwietlanie obserwacji}

Oprócz mapy z obserwacjami (znacznikami) bêdzie obok widoczna metryczka z liczb¹ obserwacji i oknem ze wszystkimi obserwacjami w dwóch trybach:
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.9]{"ikony.png"}
\end{center}
\caption{Obserwacje z metryczk¹ i zdjêciem}
\label{}
\end{figure}

\begin{figure}[h] 
\begin{center}
\includegraphics[scale =.55]{"lista.png"}
\end{center}
\caption{Lista obserwacji z pe³n¹ informacj¹}
\label{}
\end{figure}

\newpage
\section{Zapisywanie obszarów i obserwacji}
Po wyjœciu z okna \textit{Obserwacje} pojawia siê okno z zapytaniem, czy zapisaæ obserwacjê. 

\subsection{Postaæ pliku json}
Obszary i obserwacje zapisuj¹ siê w pliku typu json.

\begin{lstlisting}[language=Python, caption=Schemat pliku JSON]
{
`areas`: [
                {
                `name`: `Park Krajobrazowy A`, 
                `loc`: [(12.32121, 13.12113), (12.12121, 13.12121), (12.12521, 13.12151)]
                 },
                {
                `name`: `Park Krajobrazowy B`, 
                `loc`: [(12.32121, 15.12113), (12.12121, 15.12121), (12.12521, 15.12151)]
                 }
              ],
`observations`: [  
              {
               `area_name`: ``,
               `loc`: [(11.32121, 15.12113), (11.12121, 15.12121), (11.12521, 15.12151)],
               `events`: [
                          Tutaj obserwacje jako slowniki json prosto z bazy pobierane za pomoca funkcji pyinaturalist.get_observations() tak, aby byly konwertowalne za pomoca funkcji pyinaturalist.Observation.from_json_list() 
                         ]
                },
              {
               `area_name`: `Park Narodowy C`,
               `loc`: [(1.32121, 15.12113), (1.12121, 15.12121), (1.12521, 15.12151)],
               `events`: [
                         Jak wyzej
                         ]
                }               
}

\end{lstlisting}

Postaæ JSONów obserwacji:
\url{https://pyinaturalist.readthedocs.io/en/stable/user_guide.html#responses}
 
 \begin{figure}[h] 
\begin{center}
\includegraphics[scale =0.8]{"json.png"}
\end{center}
\caption{Format obserwacji}
\label{}
\end{figure}

\end{document}
