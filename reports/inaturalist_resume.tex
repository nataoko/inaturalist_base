%\documentclass{report}
\documentclass{article}
\usepackage{graphicx}
\usepackage[T1]{fontenc}
\usepackage{polski}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}

\usepackage{geometry}
\newgeometry{tmargin=2.5cm,bmargin=2.5cm,lmargin=3cm,rmargin=3cm}

\usepackage{listings}
\usepackage{xcolor}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\title{Baza iNaturalist --- wystêpowanie gatunków zagro¿onych na~danym obszarze\\ \large{projekt z~Pracowni informatycznej}}
\author{Natalia Okopna \\nr albumu: 123454\\\\\\\\ prowadz¹cy: dr hab. Wojciech Jakubowski}
\date{Styczeñ 2022}

\begin{document}
\maketitle
\newpage
\tableofcontents
\newpage

\section{Specyfikacja}
\subsection{Wstêpne za³o¿enia}
Pierwszym krokiem w~tworzeniu aplikacji by³o okreœlenie podstawowych celów i~za³o¿eñ aplikacji. Pierwsza wersja wygl¹da³a nastepuj¹co:

\subsubsection{Cel aplikacji — sposób dzia³ania}
Stworzona zostanie aplikacja, której g³ównym zadaniem bêdzie prezentacja na~danym obszarze obserwacji gatunków zagro¿onych z~okreœlonej rodziny. Dane obserwacji bêd¹ pobierane w~czasie rzeczywistym z~bazy internetowej iNaturalist dostêpnej pod adresem internetowym \url{www.inaturalist.org}. Obszarami dostêpnymi do~zaznaczenia bêd¹: kraje --- do~wyboru z~listy dostêpnych. Obserwacje wystêpowañ bêd¹ obejmowa³y rz¹d \textit{pieczarkowce}.

\subsubsection{Technologia wykonania aplikacji}
Kod programu bêdzie napisany w~jêzyku Python 3.8 z~u¿yciem m. in. biblioteki \textit{pyinaturalist}.

\subsubsection{Warunki techniczne}

Aplikacja bêdzie mo¿liwa do~uruchomienia na~innych komputerach z~zainstalowanym systemem \textit{Windows}. Do u¿ytkowania aplikacji wymagane jest po³¹czenie internetowe.

\subsection{Kolejne za³o¿enia oraz dane wejœciowe i~wyjœciowe}

Kolejnym za³o¿eniem do~technologii wykonania aplikacji by³o wykorzystanie biblioteki \textit{geopandas} --- biblioteki s³u¿¹cej do~tworzenia map. Jednak w~dalszej czêœci sprawozdania oka¿e siê, ¿e zostanie wykorzystanie inne rozwi¹zanie tego zagadnienia.

Nastêpnie stworzona zosta³a pierwsza wersja danych wejœciowych i~wyjœciowych dla aplikacji.
  \subsubsection{Dane wejœciowe}
 U¿ytkownik podaje w~wyznaczonym miejscu interfejsu graficznego dane wejœciowe w~okreœlony poni¿ej sposób.
 \begin{itemize}
     \item WSPÓ£RZÊDNE GEOGRAFICZNE OBSZARU\\\\ U¿ytkownik podaje minimum 3 pary wspó³rzêdnych geograficznych okreœlaj¹cych obszar, na~którym bêd¹ wyœwietlane obserwacje gatunku zagro¿onego. Wprowadzaj¹c dane, u¿ytkownik powinien pamiêtaæ o~nastêpuj¹cych zasadach:
 \begin{enumerate}
     \item ka¿da para wspó³rzêdnych ma byæ oddzielona przecinkiem i~spacj¹
     \item d³ugoœæ i~szerokoœæ ka¿dej wspó³rzêdnej ma byæ oddzielona spacj¹, 
     \item wspó³rzêdne maj¹ byæ wyra¿one w~stopniach z~dok³adnoœci¹ do~czêœci milionowej --- w~przypadku podania wspó³rzêdnej z~mniejsz¹ dok³adnoœci¹, aplikacja domyœlnie dopisuje zera,
     \item czêœci dziesiêtne wspó³rzêdnych maj¹ byæ poprzedzone kropk¹,
     \item ujemne dane maj¹ byæ poprzedzone minusem,
     \item zakres d³ugoœci geograficznej to $(-180.000000, 180.000000)$, 
     \item zakres szerokoœci geograficznej to $(-90.000000, 90.000000)$.

 \end{enumerate} Przyk³adowe dane wejœciowe wspó³rzêdnych u¿ytkownika: 
 $$-12.34565\textit{ } 1.23456,\textit{ }-12.34500\textit{ } 1.23450,\textit{ } -12.34300\textit{ } 1.23440.$$
 \item ZAKRES CZASU OBSERWACJI\\\\ U¿ytkownik podaje datê pocz¹tkow¹ oraz datê koñcow¹ okresu, dla którego bêd¹ wyœwietlane obserwacje gatunku zagro¿onego. Daty podaje w~formacie \textit{DD.MM.RRRR}, gdzie DD oznacza dzieñ, MM --- miesi¹c, RRRR --- rok.

 \end{itemize}

 \subsubsection{Dane wyjœciowe}
 Po zatwierdzeniu danych wejœciowych, zostaj¹ pobierane dane z~bazy iNaturalist i~s¹ zapisywane do~pliku na~komputerze u¿ytkownika. Nastêpnie program wyœwietla wyznaczony przez u¿ytkownika obszar wraz z~punktami obserwacji gatunku zagro¿onego. Obok mapy pojawia siê informacja o~liczbie obserwacji oraz lista z~danymi ka¿dej obserwacji takimi jak: data obserwacji, dok³adny gatunek, dane geograficzne, zdjêcie.
 
 \subsection{Uzupe³nienie danych wejœciowych i~wyjœciowych oraz zapis informacji na~dysku}
 Nastêpnie zosta³a dodana dana wyjœciowa nazwy obszaru --- mog¹ byæ to nazwy zawieraj¹ce spacjê i~znaki polskie, bez znaków specjalnych oraz do~danych wyjœciowych zosta³y dodane informacje o~zapisie na~dysku:  po zatwierdzeniu przez u¿ytkownika wejœciowych danych geograficznych, na~dysku w~osobnym folderze \textit{obszary} zostaj¹ zapisane dane geograficzne w~pliku tekstowym pod nazw¹ nazwy obszaru wprowadzonej przez u¿ytkownika w~formie zgodnej z~wprowadzonymi danymi przez u¿ytkownika, opisanej w~poprzednim rozdziale. Nastêpnie zostaj¹ pobrane dane z~bazy iNaturalist i~s¹ zapisywane pod nazw¹ nazwy obszaru do~pliku \textit{log} na~komputerze u¿ytkownika. Pobierane s¹ równie¿ zdjêcia z~rozszerzeniem \textit{jpg} obserwacji pod nazwami domyœlnymi, takimi jak w~bazie internetowej, do~osobnego folderu \textit{zdj}.
 
 \subsection{Koñcowa postaæ specyfikacji}
 Po stworzeniu projektu interface'u, nale¿a³o zmieniæ w~specyfikacji u¿yte biblioteki, format wprowadzanych danych przez u¿ytkownika oraz na~przyk³ad wyszukiwane obiekty i~zapisywane na~dysku informacje.
\subsubsection{Cel aplikacji}

 Stworzona zostanie aplikacja, której g³ównym zadaniem bêdzie prezentacja gatunków zagro¿onych na~danym obszarze. Dane obserwacji bêd¹ pobierane w~czasie rzeczywistym z~bazy internetowej iNaturalist dostêpnej pod adresem internetowym \textit{www.inaturalist.org}. Dostêpne bêdzie równie¿ generowanie obserwacji z~zapisanych wczeœniej danych historycznych. Obszary obserwacji bêd¹  wyznaczone przez u¿ytkownika. Obserwacje wystêpowañ bêd¹ obejmowa³y dowolne gatunki okreœlone nazw¹ systematyczn¹ b¹dŸ taksonem. 
 %zdj?, po najechanou na~pozycje, zaznacza siê na~mapie (?)
 %podzia³ na~gatunki obserwacji(?)
 \subsubsection{Dane wejœciowe}
 U¿ytkownik podaje w~wyznaczonym miejscu interfejsu graficznego dane wejœciowe w~okreœlony poni¿ej sposób.
 \begin{itemize}
     \item WSPÓ£RZÊDNE GEOGRAFICZNE I NAZWA OBSZARU\\\\ U¿ytkownik podaje: nazwê obszaru --- mog¹ byæ to nazwy zawieraj¹ce spacjê i~znaki polskie, bez znaków specjalnych oraz minimum 3 pary wspó³rzêdnych geograficznych okreœlaj¹cych obszar, na~którym bêd¹ wyœwietlane obserwacje gatunku zagro¿onego. Wprowadzaj¹c dane, u¿ytkownik powinien pamiêtaæ o~nastêpuj¹cych zasadach:
 \begin{enumerate}
     \item ka¿da para wspó³rzêdnych ma byæ zawarta w~okr¹g³ych nawiasach,
     \item ka¿da para wspó³rzêdnych ma byæ oddzielona przecinkiem i~ewentualn¹ spacj¹,
     \item d³ugoœæ i~szerokoœæ ka¿dej wspó³rzêdnej ma byæ oddzielona przecinkiem i~ewentualn¹ spacj¹, 
     \item wspó³rzêdne maj¹ byæ wyra¿one w~stopniach,
     \item dok³adnoœæ jest zaokr¹glana do~16-tego miejsca po przecinku,
     \item czêœci dziesiêtne wspó³rzêdnych maj¹ byæ poprzedzone kropk¹,
     \item ujemne dane maj¹ byæ poprzedzone minusem,
     \item zakres d³ugoœci geograficznej to $(-180.0000000000000000, 180.0000000000000000)$, 
     \item zakres szerokoœci geograficznej to $(-90.0000000000000000, 90.0000000000000000)$.

 \end{enumerate} Przyk³adowe dane wejœciowe wspó³rzêdnych u¿ytkownika: 
 $$(-12.34565,\textit{ } 1.23456),\textit{ }(-12.34500,\textit{ } 1.23450),\textit{ } (-12.34300,\textit{ } 1.23440)$$
 \item ZAKRES CZASU OBSERWACJI\\\\ U¿ytkownik podaje datê pocz¹tkow¹ oraz datê koñcow¹ okresu, dla którego bêd¹ wyœwietlane obserwacje gatunku zagro¿onego. Daty podaje w~formacie \textit{DD-MM-RRRR}, gdzie DD oznacza dzieñ, MM --- miesi¹c, RRRR --- rok.
 
 \item TAKSON/NAZWA\\\\U¿ytkownik zaznacza, czy podaje nazwê taksonomiczn¹ czy nazwê systematyczn¹ oraz wpisuje poszukiwany takson/nazwê.
 \end{itemize}
  
 \subsubsection{Dane wyjœciowe}
 Po zatwierdzeniu przez u¿ytkownika wejœciowych danych geograficznych oraz nazwy obszaru, na~dysku do~pliku typu \textit{json} zostaje dosiany obszar. Z zapisanych w~bazie obszarów, u¿ytkownik wybiera jeden obszar oraz podaje datê i~nazwê lub takson. Po zatwierdzeniu otrzymuje obserwacje pobrane dane z~bazy iNaturalist. Program wyœwietla wyznaczony przez u¿ytkownika obszar wraz z~punktami obserwacji gatunku zagro¿onego. Obok mapy pojawia siê informacja o~liczbie obserwacji oraz lista z~danymi ka¿dej obserwacji takimi jak: data obserwacji, dok³adny gatunek, dane geograficzne, zdjêcie. Je¿eli u¿ytkownik wyrazi zgodê, obserwacje s¹ zapisywane dopisywane pliku typu \textit{json} na~komputerze u¿ytkownika. Pobierane s¹ równie¿ zdjêcia z~rozszerzeniem \textit{jpg} obserwacji pod nazwami domyœlnymi, takimi jak w~bazie internetowej, do~osobnego folderu \textit{zdj}. Dostêpna bêdzie równie¿ mo¿liwoœæ wczytywania wczeœniej zapisanych obserwacji.
 

 \subsubsection{Technologia wykonania aplikacji}
 Kod programu bêdzie napisany w~jêzyku Python 3.8 z~u¿yciem m. in. biblioteki \textit{pyinaturalist} s³u¿¹ca do~obs³ugi danych z~bazy iNaturalist oraz \textit{shapely} i~\textit{folium} odpowiadaj¹ce za obrazowanie wspó³rzêdnych geograficznych.
 \subsubsection{Warunki techniczne}
 Aplikacja bêdzie mo¿liwa do~uruchomienia na~innych komputerach z~zainstalowanym systemem \textit{Windows}. Do~u¿ytkowania aplikacji wymagane jest po³¹czenie internetowe.

 \newpage
 \section{Projekt interface'u}
 \subsection{Schemat blokowy interface'u oraz jednego z~modu³ów}
Nastêpnie zosta³ stworzony schemat blokowy interface'u oraz jednego z~modu³ów. Ju¿ na~tym etapie okaza³o siê, ¿e zaproponowane w~specyfikacji rozwi¹zania musz¹ ulec zmianie. Dzieje siê tak na~przyk³ad z~postaci¹ wprowadzonych przez u¿ytkownika danych geograficznych.
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale =.1]{"projekt interace'u.png"}
%\end{center}
\\
Rysunek: Schemat blokowy interface'u
%\label{}
%\end{figure}
\end{tabular}
\end{center}
%\newpage
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale = 0.1]{"sprawdŸ dane geo.png"}
%\end{center}
\\Rysunek: Schemat blokowy sprawdzaj¹cy dane geograficzne
%\label{}
%\end{figure}
\end{tabular}
\end{center}
\newpage

%\begin{figure}[h] 
%\begin{center}
%\includegraphics[scale =0.07]{"projekt interace'u.png"}
%\end{center}
%\caption{Interface}
%\label{}
%\end{figure}
%  \begin{figure}[h] 
%\begin{center}
%\includegraphics[scale =0.07]{"sprawdŸ dane geo.png"}
%\end{center}
%\caption{sprawdŸ dane geograficzne}
%\label{}
%\end{figure}

Szybko okaza³o siê, ¿e schemat blokowy nie jest wymagany, a zale¿y nam na~dobrym zaplanowaniu front- i~backendu.
\subsection{Frontend}

\subsubsection{Pierwsza wersja}
Pierwszym pomys³em by³o stworzenie menu, z~którego dostêpne bêd¹ opcje wczytywania obszaru i~obserwacji
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale = 1]{"menu0.png"}
%\end{center}
\\Rysunek: Menu
%\label{}
%\end{figure}
\end{tabular}
\end{center}
\newpage
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale = 0.9]{"nowy obszar.png"}
%\end{center}
\\Rysunek: Menu\\
\includegraphics[scale = 0.9]{"generuj z wczytanego obszaru.png"}
%\end{center}
\\Rysunek: Menu
%\label{}
%\end{figure}
\end{tabular}
\end{center}
\newpage

Jednak interface skonstruowany w~ten sposób  by³ nieintuicyjny. Najbardziej rzucaj¹cym siê w~oczy problemem by³a mo¿liwoœæ generowania obserwacji w~kilku miejscach. W~zwi¹zku z~tym stworzony zosta³ nowy projekt interface'u.
\subsubsection{Menu}
 Po otwarciu aplikacji u¿ytkownik dostaje kilka mo¿liwoœci do~wyboru. Zapis nowego obszaru, wczytanie informacji oraz wyœwietlenie informacjo o~aplikacji.
  \begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"menu.png"}
\end{center}
\caption{Menu}
\label{}
\end{figure}
 \newpage
\subsubsection{Okno wprowadzania obszaru}
 Po klikniêciu w~menu g³ównym opcji \textit{Nowy obszar} otwiera nam siê nastêpuj¹ce okno.
 
 \begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"NowyObszar.png"}
\end{center}
\caption{Okno 'Nowy obszar'}
\label{}
\end{figure}
 Docelowo po wprowadzeniu ka¿dego punktu, generowany bêdzie interaktywnie obszar.
\newpage\subsubsection{Okna informacyjne} Po zatwierdzeniu obszaru rozpoczyna siê proces walidacji oraz sprawdzenie, czy obszar jest spójny, omówione w~nastêpnym rozdziale. W razie b³êdu wyœwietli siê nastêpuj¹ce okno.
 
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"error5.png"}
\end{center}
\caption{Okno 'Error'}
\label{}
\end{figure}

W przeciwnym razie obszar zostaje zapisany do~bazy. Pojawia siê okno z~informacj¹.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"Zapisano.png"}
\end{center}
\caption{Okno informuj¹ce o~zapisaniu obrazu}
\label{}
\end{figure}


\subsubsection{Wczytywanie obserwacji}
Po klikniêciu w~menu g³ównym opcji \textit{Obserwacje} wyœwietla nam siê nastêpuj¹ce okno.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"wczytajobs.png"}
\end{center}
\caption{Wczytywanie obserwacji}
\label{}
\end{figure}
\newpage
\subsubsection{Wczytywanie obserwacji z~dysku} Po klikniêciu \textit{Wczytaj z~dysku} otwiera nam siê okno \textit{Wczytaj obserwacje z~dysku}. 

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"wczytajobszdysku.png"}
\end{center}
\caption{Wczytywanie obserwacji z~dysku}
\label{}
\end{figure}

Po klikniêciu \textit{Ok} wyœwietli siê okno \textit{Obserwacje} z~wizualizacj¹ danych omówion¹ w~kolejnych punktach.

To okno zosta³o poprawione o wyœwietlanie zarówno nazw taksonomicznych jak i systematycznych.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"wczytajobszdysku1.png"}
\end{center}
\caption{Wczytywanie obserwacji z~dysku poprawione}
\label{}
\end{figure}

\newpage
\subsubsection{Generowanie obserwacji z~bazy}
W pierwszej wersji po klikniêciu \textit{Generuj z~bazy} mia³o otwieraæ siê nastêpuj¹ce okno. 

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"generujzbazy.png"}
\end{center}
\caption{Generowanie z~bazy}
\label{}
\end{figure}

Mo¿liwe b³êdy to: data spoza zakresu, z³y takson, brak internetu. W razie b³êdów bêd¹ pojawia³y siê odpowiednie okna b³êdu. Po zatwierdzeniu danych i~wciœniêciu przycisku \textit{Generuj} zostaje wysy³ane zapytanie do~bazy i~wygenerowanie obserwacji. Zostaje wyœwietlone okno \textit{Obserwacje} omówione w~dalszej czêœci. 

Po konsultacji okaza³o siê, ¿e warto poprawiæ jego wygl¹d. Nastêpna wersja tego okna by³a nastêpuj¹ca.

U¿ytkownik wpisuj¹c nazwê systematyczn¹ mo¿e sprawdziæ dostêpne nazwy. Lista dostêpnych nazw bêdzie generowana automatycznie.
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"gzb1.png"}
\end{center}
%\caption{Obserwacje}
\label{}
\end{figure}
\begin{center}
\begin{tabular}{l}
B¹dŸ po wciœniêciu \textit{Szukaj} --- w~zale¿noœci od tego, co siê oka¿e lepsze, w~trakcie tworzenia programu.\\\\
\\\includegraphics[scale = 1]{"gzb2.png"}\\\\
\\Po wybraniu lub wpisaniu odpowiedniej nazwy komórka podœwietli siê na~zielono.\\\\
\\\includegraphics[scale = 1]{"gzb3.png"}
\end{tabular}
\end{center}
\begin{center}
\begin{tabular}{l}
Dostêpne bêdzie równie¿ wybranie taksonu. W tym przypadku u¿ytkownik powinien podaæ \\poprawn¹ nazwê taksonu. Na liœcie pojawi siê szukana pozycja oraz jej dzieci taksonomiczne.\\\\
\\\\\includegraphics[scale = 1]{"gzb4.png"}\\\\
\\Po wybraniu lub wpisaniu odpowiedniej pozycji, komórka podœwietli siê na~zielono.\\\\
\\\includegraphics[scale = 1]{"gzb5.png"}\\\\
\\Jeœli przy wciœniêciu przycisku Generuj nazwa nie bêdzie podœwietlona na~zielono, pojawi siê informacja \\w postaci okienka erroru.
\end{tabular}
\end{center}

\newpage
Po kolejnej konsultacji okaza³o siê, ¿e bezpieczniej bêdzie stworzyæ dodatkowe okno, w~którym u¿ytkownik deklaruje, czy bêdzie wpisywa³ takson, czy nazwê. Po wpisaniu taksonu, poni¿ej okna z~wpisywaniem, poka¿e siê nazwa oraz inne wa¿ne informacje do~przypisanego taksonu.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"gzb6.png"}
\end{center}
%\caption{Obserwacje}
\label{}
\end{figure}

\newpage
\subsubsection{Wizualizacja danych}
Po wprowadzeniu obserwacji nastêpuje wyœwietlenie obserwacji. Poszczególne elementy okna s¹ opisane w~nastêpnym rozdziale.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 1]{"obserwacje.png"}
\end{center}
\caption{Obserwacje}
\label{}
\end{figure}

Po wyjœciu z~okna \textit{Obserwacje} pojawia siê okno z~zapytaniem, czy zapisaæ obserwacjê. O formie zapisu jest powiedziane w~kolejnym rozdziale.

\newpage
 \subsection{Backend}
 W odpowiedzi na potrzebê zaprogramowania obs³ugi obszarów oraz map, skorzysta³am z biblioteki \textit{shapely} oraz \textit{folium}. Pierwsza z nich pozwala nie tylko na tworzenia obszarów, ale i~na~walidacjê danych, na przyk³ad pod wzglêdem kryterium spójnoœci. Druga biblioteka pozwala na tworzenie interaktywnych map. Dostêpne s¹ równie¿ przyk³ady u¿ycia obu bibliotek do tworzenia takich obszarów jak poszczególne kraje, czy kontynenty. Nieoceniona w projekcie okaza³a siê równie¿ biblioteka \textit{pyinaturalist} pozwalaj¹ca na œci¹ganie danych z bazy iNaturalist. Dodatkow¹ bibliotek¹, która bêdzie wprowadzona z drobnymi zmianami jest \textit{ipyplot}. Biblioteka jest przeznaczona do u¿ycia w notatnikach python'owskich, st¹d potrzeba wprowadzenia niewielkich zmian w jej kodzie.
 
  \subsubsection{Wprowadzanie nowego obszaru}
 Aby wygenerowaæ opcje na~danym obszarze, taki obszar musi byæ wczeœniej wprowadzony do~bazy. 
 
 \subsubsection*{Tworzenie obszarów}
Do tworzenia obszarów bêdziemy korzystaæ z~biblioteki \textit{shapely.geometry}.
Tworzymy przyk³adowy obszar u¿ywaj¹c funkcji \textit{shapely.geometry.Polygon}. Jako argument dajemy listê punktów danych geograficznych.

\begin{lstlisting}[language=Python, caption=Przyk³adowy obszar]
from shapely.geometry import Polygon

test = [(10,0), (10,1), (10.5,0.5), (11,1), (11,0)]
test = Polygon(test)
test
\end{lstlisting}
Otrzymujemy obszar:

\begin{figure}[h] 
\begin{center}
\includegraphics[scale =1]{"polygon.PNG"}
\end{center}
\caption{Przyk³adowy obszar `test`}
\label{test}
\end{figure}

\subsubsection*{Obszar spójny}
Sprawdzamy, czy wprowadzony przez u¿ytkownika obszar jest poprawny za pomoc¹ funkcji \textit{shapely.geometry.Polygon.is\_valid}. Funkcja zwraca
wartoœæ logiczn¹ \textit{True}, gdy obszar jest spójny. Mo¿e wiêc byæ to obszar wklês³y. Wiêcej mo¿na poczytaæ o~tej funkcji w~dokumentacji:  \url{https://shapely.readthedocs.io/en/stable/manual.html#polygons}.
Sprawdzamy poprawnoœæ stworzonego wczeœniej obszaru Rysunek \ref{test}.
\begin{lstlisting}[language=Python, caption=Obszar spójny]
test.is_valid
#True
\end{lstlisting}
Tworzymy obszar, w~którym linie miêdzy punktami nachodz¹ na~siebie (obszar nie jest spójny).
\begin{lstlisting}[language=Python, caption=Obszar spójny]
test1 = [(0,0), (0,1), (0.5,-1), (1,1), (1,0)]
test1 = Polygon(test1)
test1
\end{lstlisting}
Otrzymujemy figurê:
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 2]{"niespojny.PNG"}
\end{center}
\caption{Obszar niespójny `test1`}
\label{}
\end{figure}
Sprawdzamy jego poprawnoœæ:
\begin{lstlisting}[language=Python, caption=Obszar niespójny]
test1.is_valid
#False
\end{lstlisting}
Funkcja \textit{shapely.geometry.Polygon.is\_valid} zwraca wartoœæ \textit{False}. Czyli obszar nie jest poprawny.

\subsubsection*{Walidacja danych}
Aby korzystaæ z~funkcji \textit{shapely.Polygon} trzeba sprawdziæ poprawnoœæ danych wprowadzonych przez u¿ytkownika.
\begin{itemize}
\item Linia i~punkt \\ 
W naszym programie obszar powinien zawieraæ minimum 3 punkty. Tworzymy funkcjê \textit{geo\_less\_than\_3}.
\begin{lstlisting}[language=Python, caption=geo\_less\_than\_3]
def geo_less_than_3(lista):
    if len(lista) < 3:
        return 1
return 0
\end{lstlisting}
Przyk³adowe wyjœcia funkcji:
\begin{lstlisting}[language=Python, caption=Za ma³o danych]
geo_less_than_3([('0','0')])
#1
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Za ma³o danych]
geo_less_than_3([('0','0'), ('0','1')])
#1
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Minimalna liczba danych]
geo_less_than_3([('0','0'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\item Inne znaki i~zakres liczbowy.
Sprawdzamy, czy dane wejœciowe u¿ytkownika to liczby i~to liczby z~zakresu szerokoœci i~d³ugoœci geograficznych œwiata. Tworzymy funkcjê \textit{geo\_float}, która zwraca numer b³êdu lub przekonwertowan¹ listê danych geograficznych.
\begin{lstlisting}[language=Python, caption=geo\_float]
def geo_float(lista):
  lista_float = []
  try:
    for long, lati in lista:
      try:
        long = round(float(long), 5)
        if long < -180 or long > 180:
          return 3
      except:
        return 2
      try:
        lati = round(float(lati), 5)
        if lati < -90 or lati > 90:
          return 5
      except:
        return 4
      lista_float.append((long, lati))
  except:
    return 0
  return lista_float
\end{lstlisting}
Przyk³ady: \\
wpisujemy b³êdne dane: 
\begin{lstlisting}[language=Python, caption=za krótka krotka]
geo_float([('0'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=za d³uga krotka]
geo_float([('1', '0','4'), ('0','1'), ('0','2')])
#0
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=inne znaki]
geo_float([('0','a'), ('0','1'), ('0','2')])
#4
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=inne znaki]
geo_float([('a', '0'), ('0','1'), ('0','2')])
#2
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=liczby poza skal¹]
geo_float([('200', '0'), ('0','1'), ('0','2')])
#3
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=liczby poza skal¹]
geo_float([('2', '100'), ('0','1'), ('0','2')])
#5
\end{lstlisting}
oraz poprawne dane.
\begin{lstlisting}[language=Python, caption=poprawne dane]
geo_float([('1', '0'), ('0','1'), ('0','2')])
# [(1.0, 0.0), (0.0, 1.0), (0.0, 2.0)]
\end{lstlisting}
\end{itemize}

\subsubsection{Wprowadzanie nazwy/taksonu}
W programie za wyszukiwanie nazw i~taksonów bêdzie odpowiedzialna funkcja \textit{get\_taxa} z~biblioteki \textit{pyinaturalist}.

\subsubsection{Zapytanie do~bazy}
Zapytanie do~bazy bêdzie kierowane poprzez funkcjê \textit{pyinaturalist.get\_observation\_species\_counts}, która bierze jako argumenty takson, datê startow¹ i~koñcow¹ obserwacji oraz wartoœæ 0-1 czy gatunek danej obserwacji ma byæ zagro¿ony w~lokalizacji obserwacji oraz czy obserwacja jest zweryfikowana. Mo¿na te¿ ustaliæ inne dodatkowe parametry o~których wiêcej mo¿na poczytaæ w~dokumentacji: \url{https://pyinaturalist.readthedocs.io/en/stable/modules/pyinaturalist.v1.observations.html#pyinaturalist.v1.observations.get_observation_species_counts}. Otrzymujemy zestaw obserwacji w~postaci s³ownika JSON.
 \subsubsection{Obserwacja w~obszarze}
Nastêpnie nale¿y sprawdziæ, które obserwacje nalez¹ do~danego. Tworzymy punkt przy u¿yciu funkcji
\textit{shapely.geometry.Point}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
from shapely.geometry import Point
p1 = Point(10.5, 0.2)
\end{lstlisting}
Nastêpnie korzystamy z~funkcji \textit{shapely.geometry.Polygon.contains()}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
test.contains(p1)
#True
\end{lstlisting}
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
p2 = Point(10.5, 1.2)
test.contains(p2)
#False
\end{lstlisting}
Punkt \textit{p1} nale¿y do~obszaru \textit{test}, punkt \textit{p2} nie nale¿y.
\\\\Gdy mamy przefiltrowane obserwacje, zostaje wyœwietliæ je na~mapie oraz w~odpowiedni wizualnie sposób.

\subsubsection{Tworzenie mapy}
Aby umieœciæ obszary na~mapie, skorzystamy z~biblioteki \textit{folium}: \url{https://python-visualization.github.io/folium/quickstart.html}.

Tworzymy obiekt \textit{mapa} okreœlaj¹c wymiary okna oraz widok. Domyœlny tryb mapy to: \textit{tiles = 'OpenStreetMap'}. W aplikacji bêdzie mo¿na zmieniæ tryb na~\textit{'cartodbpositron'} oraz \textit{'Stamen Terrain'}.
\begin{lstlisting}[language=Python, caption=Mapa]
import folium
mapa = folium.Map(width=500, height=400, location=[0,10], zoom_start=5)
folium.TileLayer('cartodbpositron').add_to(mapa)
folium.TileLayer('Stamen Terrain').add_to(mapa)
folium.LayerControl().add_to(mapa)
mapa
\end{lstlisting}
\begin{center}
\begin{tabular}{c}
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale =.75]{"mapaopcje.PNG"}
%\end{center}
\\
Rysunek: Domyœlny tryb
%\label{}
%\end{figure}
\\\\\\\\
%\begin{figure}[h] 
%\begin{center}
\includegraphics[scale = .75]{"mapa3.PNG"}
%\end{center}
\\Rysunek: Tryb 'cartodbpositron'
%\label{}
%\end{figure}
\end{tabular}
\end{center}
\newpage

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.75]{"mapaST.PNG"}
\end{center}
\caption{Tryb 'Stamen Terrain'}
\label{}
\end{figure}

\subsubsection{Umieszczanie obszaru na~mapie}
Do mapy \textit{mapa} dodajemy nasz obszar \textit{test}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
import folium
mapa = folium.Map(width=500, height=400, location=[0,10], zoom_start=8)
folium.GeoJson(test).add_to(mapa) # dodanie obszaru
folium.TileLayer('cartodbpositron').add_to(mapa)
folium.TileLayer('Stamen Terrain').add_to(mapa)
folium.LayerControl().add_to(mapa)
mapa
\end{lstlisting}
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.5]{"mapaobszar.PNG"}
\end{center}
\caption{Mapa z~obszarem}
\label{}
\end{figure}
\subsubsection{Umieszczanie obserwacji na~mapie}

Tworzymy obiekt punktu korzystaj¹c z~funkcji \textit{folium.Marker}.
\begin{lstlisting}[language=Python, caption=Dodanie obszaru]
folium.Marker([0, 10], popup="Znacznik").add_to(mapa)
mapa
\end{lstlisting}

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.55]{"znacznik.PNG"}
\end{center}
\caption{Mapa ze znacznikiem}
\label{}
\end{figure}

\subsubsection{Znacznik}
Docelowo po klikniêciu na~znacznik bêdziemy widzieli okno. Skorzystamy z~biblioteki \url{https://github.com/karolzak/ipyplot} w~zmienionej na~nasze potrzeby formie. Ta czêœæ bêdzie uwzglêdniona dopiero w~procesie tworzenia aplikacji w~przysz³oœci.

\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.65]{"znacznikfoto.PNG"}
\end{center}
\caption{Znacznik z~informacjami}
\label{}
\end{figure}

\subsubsection{Wyœwietlanie obserwacji}

Oprócz mapy z~obserwacjami (znacznikami) bêdzie obok widoczna metryczka z~liczb¹ obserwacji i~oknem ze wszystkimi obserwacjami w~dwóch trybach:
\begin{figure}[h] 
\begin{center}
\includegraphics[scale = 0.9]{"ikony.png"}
\end{center}
\caption{Obserwacje z~metryczk¹ i~zdjêciem}
\label{}
\end{figure}

\begin{figure}[h] 
\begin{center}
\includegraphics[scale =.55]{"lista.png"}
\end{center}
\caption{Lista obserwacji z~pe³n¹ informacj¹}
\label{}
\end{figure}

\newpage
\subsection{Zapisywanie obszarów i~obserwacji}
Po wyjœciu z~okna \textit{Obserwacje} pojawia siê okno z~zapytaniem, czy zapisaæ obserwacjê. 

\subsubsection{Postaæ pliku json}
Obszary i~obserwacje zapisuj¹ siê w~pliku typu json.

Pierwsza wersja by³a nastêpuj¹ca.
\begin{lstlisting}[language=Python, caption=Schemat pliku JSON]
{
`areas`: [
                {
                `name`: `Park Krajobrazowy A`, 
                `loc`: [(12.32121, 13.12113), (12.12121, 13.12121), (12.12521, 13.12151)]
                 },
                {
                `name`: `Park Krajobrazowy B`, 
                `loc`: [(12.32121, 15.12113), (12.12121, 15.12121), (12.12521, 15.12151)]
                 }
              ],
`observations`: [  
              {
               `area_name`: ``,
               `loc`: [(11.32121, 15.12113), (11.12121, 15.12121), (11.12521, 15.12151)],
               `events`: [
                          Tutaj obserwacje jako slowniki json prosto z~bazy pobierane za pomoca funkcji pyinaturalist.get_observations() tak, aby byly konwertowalne za pomoca funkcji pyinaturalist.Observation.from_json_list() 
                         ]
                },
              {
               `area_name`: `Park Narodowy C`,
               `loc`: [(1.32121, 15.12113), (1.12121, 15.12121), (1.12521, 15.12151)],
               `events`: [
                         Jak wyzej
                         ]
                }               
}

\end{lstlisting}
Jednak po zmianach wprowadzonych w~interfac'e plik json bêdzie wygl¹daæ w~ten sposób.
\begin{lstlisting}[language=Python, caption=Schemat pliku JSON]
{
`areas`: [
                {
                `name`: `Park Krajobrazowy A`, 
                `loc`: [(12.32121, 13.12113), (12.12121, 13.12121), (12.12521, 13.12151)]
                 },
                {
                `name`: `Park Krajobrazowy B`, 
                `loc`: [(12.32121, 15.12113), (12.12121, 15.12121), (12.12521, 15.12151)]
                 }
              ],
`observations`: [  
              {
               `area_name`: `Park Krajobrazowy A`,
               `data`: {'start': '12-12-2021', 'stop': '20-12-2021'},
               `events`: [
                          Tutaj obserwacje jako slowniki json prosto z~bazy pobierane za pomoca funkcji pyinaturalist.get_observations() tak, aby byly konwertowalne za pomoca funkcji pyinaturalist.Observation.from_json_list() 
                         ]
                },
              {
               `area_name`: `Park Narodowy C`,
               `data`: {'start': '12-12-2021', 'stop': '20-12-2021'},
               `events`: [
                         Jak wyzej
                         ]
                }               
}
\end{lstlisting}
Postaæ JSONów obserwacji:
\url{https://pyinaturalist.readthedocs.io/en/stable/user_guide.html#responses}
 
 \begin{figure}[h] 
\begin{center}
\includegraphics[scale =1]{"json.png"}
\end{center}
\caption{Format obserwacji}
\label{}
\end{figure}

\end{document}
